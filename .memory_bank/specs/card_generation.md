# Specification: Card Generation Feature

## Feature ID
`CARD-GEN-01`

## Overview
Модуль генерации корпоративных открыток с использованием AI (Google Gemini) для создания стилизованного текста и уникальных изображений.

## Business Context
Позволяет сотрудникам создавать персонализированные открытки благодарности для коллег с минимальными усилиями, используя генеративный AI для творческой обработки контента.

## User Stories

### US-01: Создание открытки
**Как** сотрудник компании,
**Я хочу** создать поздравительную открытку для коллеги,
**Чтобы** выразить благодарность в творческой форме.

### US-02: AI-стилизация текста
**Как** пользователь,
**Я хочу** выбрать стиль оформления текста,
**Чтобы** получить уникальный и интересный вариант благодарности.

### US-03: Генерация изображения
**Как** пользователь,
**Я хочу** получить AI-сгенерированное изображение в выбранном стиле,
**Чтобы** открытка была визуально привлекательной.

### US-04: Перегенерация контента
**Как** пользователь,
**Я хочу** иметь возможность перегенерировать текст или изображение,
**Чтобы** выбрать лучший вариант из предложенных.

---

## Functional Requirements

### FR-01: Форма создания открытки

#### FR-01.1: Поле "Кому" (Адресат)
- **Тип**: Combobox с автодополнением
- **Источник данных**: Список сотрудников из репозитория
- **Валидация**: Обязательное поле
- **Поведение**:
  - При вводе текста список фильтруется
  - Пользователь может выбрать значение только из списка
  - Кастомный ввод невозможен

#### FR-01.2: Поле "От кого" (Отправитель)
- **Тип**: Текстовое поле
- **Валидация**: Необязательное, макс. 100 символов
- **Поведение**: Если пустое, открытка считается анонимной

#### FR-01.3: Поле "За что" (Краткая суть)
- **Тип**: Однострочное текстовое поле
- **Валидация**: Необязательное, макс. 150 символов

#### FR-01.4: Поле "Слова благодарности" (Основной текст)
- **Тип**: Многострочное текстовое поле (textarea)
- **Валидация**: Необязательное, макс. 1000 символов

#### FR-01.5: Опция "Улучшить текст"
- **Состав**: Чекбокс + группа из 5 радиокнопок
- **Начальное состояние**: Чекбокс не отмечен, радиокнопки disabled
- **Поведение**: При активации чекбокса радиокнопки становятся активными
- **Стили текста**:
  1. `ode` - Торжественная ода
  2. `future` - Отчет из будущего
  3. `haiku` - Хайку / Короткое стихотворение
  4. `newspaper` - Заметка в газете "Вестник Компании"
  5. `standup` - Дружеский стендап

#### FR-01.6: Опция "Стиль изображения"
- **Тип**: Группа из 4 радиокнопок (single choice)
- **Валидация**: Обязательный выбор
- **Стили изображения**:
  1. `digital_art` - Цифровая живопись
  2. `pixel_art` - Пиксель-арт
  3. `space` - Космическая фантастика
  4. `movie` - Кадр из фильма

#### FR-01.7: Кнопка "Сгенерировать открытку"
- **Доступность**: Активна только если:
  - Заполнено поле "Кому"
  - Выбран стиль изображения
- **Поведение при клике**:
  - Кнопка блокируется
  - Отображается индикатор загрузки
  - Запускается процесс генерации

#### FR-01.8: Подсказки
- Неблокирующий tooltip при минимальном заполнении:
  "Для лучшего результата заполните поля 'За что' и 'Слова благодарности'"

---

### FR-02: Процесс генерации

#### FR-02.1: Генерация текста
Два режима работы:

**Режим 1: Без AI (enhance_text = false)**
- Используется только оригинальный текст пользователя
- Результат: 1 вариант (style="original")

**Режим 2: С AI (enhance_text = true)**
- Исходный текст сохраняется как первый вариант
- AI генерирует 3 дополнительных варианта
- Результат: 4 варианта (1 оригинал + 3 AI-стилизованных)
- **UI на втором экране**:
  - Оригинальный текст показан отдельно (сверху) с radio "Использовать"
  - AI варианты показаны в карусели ниже
  - Пользователь выбирает между своим текстом и AI-вариантами
- Входные данные: reason, message, text_style

#### FR-02.2: Генерация изображения
- Отправка запроса к Gemini API для создания изображения
- Входные данные: recipient, reason (опционально), image_style
- Результат: Изображение в формате PNG/JPEG

#### FR-02.3: Параллельная генерация
- Текст и изображение должны генерироваться параллельно (asyncio.gather)
- Timeout: 60 секунд на каждую операцию

---

### FR-03: Интерфейс просмотра и выбора

#### FR-03.1: Карусели
- Два блока: "Изображение" и "Текст"
- Каждый блок - карусель для пролистывания вариантов

#### FR-03.2: Механизм перегенерации
- Под каждой каруселью: кнопка "Перегенерировать" + счетчик попыток
- Начальное значение счетчика: 3
- При каждой перегенерации:
  - Новый вариант добавляется в карусель
  - Счетчик уменьшается на 1
- При достижении 0: кнопка становится неактивной

#### FR-03.3: Выбор финального варианта
- Каждый вариант в карусели имеет чекбокс "Выбрать"
- При выборе одного варианта остальные чекбоксы становятся disabled
- Необходимо выбрать один текст И одно изображение

---

## API Specification

### POST /api/v1/cards/generate

Генерация новой открытки.

**Request Body:**
```json
{
  "recipient": "Иван Иванов",
  "sender": "Петр Петров",
  "reason": "За отличную работу над проектом",
  "message": "Спасибо за твой вклад в успех команды!",
  "enhance_text": true,
  "text_style": "ode",
  "image_style": "digital_art"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "generation_id": "uuid-string",
    "text_variants": [
      {
        "id": "text-1",
        "content": "О великий труженик проектов славных...",
        "style": "ode"
      }
    ],
    "image_variants": [
      {
        "id": "img-1",
        "url": "/api/v1/images/temp/uuid",
        "style": "digital_art"
      }
    ],
    "remaining_text_regenerations": 3,
    "remaining_image_regenerations": 3
  }
}
```

### POST /api/v1/cards/regenerate

Перегенерация текста или изображения.

**Request Body:**
```json
{
  "generation_id": "uuid-string",
  "type": "text",
  "original_request": {
    "message": "...",
    "text_style": "ode"
  }
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "variant": {
      "id": "text-2",
      "content": "Новый вариант стилизованного текста...",
      "style": "ode"
    },
    "remaining_regenerations": 2
  }
}
```

### POST /api/v1/cards/send

Отправка открытки в Telegram.

**Request Body:**
```json
{
  "generation_id": "uuid-string",
  "selected_text_id": "text-1",
  "selected_image_id": "img-1"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "message": "Открытка для Иван Иванов успешно отправлена!",
    "telegram_message_id": 12345
  }
}
```

---

## Data Models

### CardGenerationRequest
```python
class CardGenerationRequest(BaseModel):
    recipient: str = Field(..., min_length=1)
    sender: Optional[str] = Field(None, max_length=100)
    reason: Optional[str] = Field(None, max_length=150)
    message: Optional[str] = Field(None, max_length=1000)
    enhance_text: bool = False
    text_style: Optional[TextStyle] = None
    image_style: ImageStyle
```

### CardGenerationResponse
```python
class CardGenerationResponse(BaseModel):
    generation_id: str
    text_variants: List[TextVariant]
    image_variants: List[ImageVariant]
    remaining_text_regenerations: int
    remaining_image_regenerations: int
```

### TextVariant
```python
class TextVariant(BaseModel):
    id: str
    content: str
    style: Optional[TextStyle]
```

### ImageVariant
```python
class ImageVariant(BaseModel):
    id: str
    url: str
    style: ImageStyle
```

---

## Acceptance Criteria

### AC-01: Валидация формы
- [ ] Кнопка генерации неактивна без заполнения обязательных полей
- [ ] Поле "Кому" позволяет выбор только из списка
- [ ] Ограничения символов работают корректно
- [ ] Стили текста активируются только при включенном чекбоксе

### AC-02: Генерация контента
- [ ] Текст генерируется в выбранном стиле
- [ ] Изображение соответствует выбранному стилю
- [ ] Генерация завершается за разумное время (< 60 сек)
- [ ] При ошибке генерации показывается понятное сообщение

### AC-03: Перегенерация
- [ ] Новые варианты добавляются в карусель
- [ ] Счетчик попыток уменьшается
- [ ] При 0 попыток кнопка блокируется

### AC-04: Выбор варианта
- [ ] Можно выбрать только один текст
- [ ] Можно выбрать только одно изображение
- [ ] Кнопка отправки активна после выбора обоих

---

## Non-Functional Requirements

### Performance
- Генерация текста: < 10 сек
- Генерация изображения: < 30 сек
- Общее время: < 60 сек (параллельно)

### Reliability
- Retry при временных ошибках Gemini API (3 попытки)
- Graceful degradation при недоступности сервиса

### Security
- API ключи не передаются на фронтенд
- Валидация всех входных данных
- Санитизация текста для предотвращения injection

---

## UI/UX Notes

- Индикатор прогресса во время генерации
- Анимация появления результатов
- Плавный переход между вариантами в карусели
- Подсказки для улучшения качества результата

---

## Dependencies
- Google Gemini API (text + image generation)
- Employee Repository (для списка получателей)
- Telegram Integration (для отправки)

## Related Specifications
- [Admin Panel](./admin_panel.md)
- [Telegram Integration](./telegram_integration.md)

---

**Version**: 1.0
**Last Updated**: 2023-11-26
**Status**: Draft
